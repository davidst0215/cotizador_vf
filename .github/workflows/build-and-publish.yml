name: Build & Publish Backend & Frontend Images

on:
  push:
    branches: [ main ]

concurrency:
  group: build-and-push-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io
  OWNER: ${{ github.repository_owner }}
  REPO: ${{ github.event.repository.name }}
  # use GITHUB_TOKEN by default; override with secrets.DOCKER_PAT if needed
  CR_PAT: ${{ secrets.DOCKER_PAT || secrets.GITHUB_TOKEN }}
  TAG_FULL: ${{ github.sha }}
  TAG_SHORT: ${{ github.sha[:7] }}

jobs:
  build-and-push:
    name: Build & push images
    runs-on: ubuntu-latest

    # build backend and frontend in parallel
    strategy:
      matrix:
        service: [backend, frontend]
      fail-fast: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up QEMU (optional, for multi-arch)
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          buildkitd-flags: --debug

      - name: Log in to registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ env.CR_PAT }}

      - name: Define image variables
        id: vars
        run: |
          SERVICE=${{ matrix.service }}
          IMAGE=${{ env.REGISTRY }}/${{ env.OWNER }}/${{ env.REPO }}-${SERVICE}
          echo "service=$SERVICE" >> $GITHUB_OUTPUT
          echo "image=$IMAGE" >> $GITHUB_OUTPUT
          echo "tags=${IMAGE}:latest,${IMAGE}:${{ env.TAG_FULL }},${IMAGE}:${{ env.TAG_SHORT }}" >> $GITHUB_OUTPUT

      - name: Build & push image (${{ matrix.service }})
        uses: docker/build-push-action@v5
        with:
          context: ./${{ matrix.service }}
          file: ./${{ matrix.service }}/Dockerfile
          push: true
          platforms: linux/amd64 #,linux/arm64
          # use registry cache to speed up incremental builds
          cache-from: type=registry,ref=${{ steps.vars.outputs.image }}:cache
          cache-to: type=registry,ref=${{ steps.vars.outputs.image }}:cache,mode=max
          tags: ${{ steps.vars.outputs.tags }}
          build-args: |
            GIT_COMMIT=${{ env.TAG_FULL }}
            GIT_SHORT=${{ env.TAG_SHORT }}
          labels: |
            org.opencontainers.image.revision=${{ env.TAG_FULL }}
            org.opencontainers.image.source=${{ github.repository }}

      - name: Output pushed image refs
        run: |
          echo "Pushed: ${{ steps.vars.outputs.tags }}"
